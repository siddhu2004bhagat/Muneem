<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Palm Rejection Manual Test</title>
  <style>
    body {
      margin: 0;
      padding: 20px;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #f5f5f5;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
    }
    
    h1 {
      color: #333;
      margin-bottom: 10px;
    }
    
    .subtitle {
      color: #666;
      margin-bottom: 30px;
    }
    
    .test-canvas {
      width: 100%;
      height: 600px;
      background: white;
      border: 2px solid #ddd;
      border-radius: 8px;
      cursor: crosshair;
      touch-action: none;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .controls {
      margin: 20px 0;
      padding: 20px;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .control-group {
      margin: 15px 0;
      display: flex;
      align-items: center;
      gap: 15px;
    }
    
    label {
      font-weight: 600;
      min-width: 180px;
      color: #555;
    }
    
    input[type="range"] {
      flex: 1;
      max-width: 300px;
    }
    
    input[type="checkbox"] {
      width: 20px;
      height: 20px;
    }
    
    .value-display {
      min-width: 60px;
      font-family: monospace;
      color: #007bff;
      font-weight: bold;
    }
    
    button {
      padding: 10px 20px;
      margin: 5px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: all 0.2s;
    }
    
    .btn-primary {
      background: #007bff;
      color: white;
    }
    
    .btn-primary:hover {
      background: #0056b3;
    }
    
    .btn-secondary {
      background: #6c757d;
      color: white;
    }
    
    .btn-secondary:hover {
      background: #545b62;
    }
    
    .btn-danger {
      background: #dc3545;
      color: white;
    }
    
    .btn-danger:hover {
      background: #c82333;
    }
    
    .log {
      margin-top: 20px;
      padding: 15px;
      background: #1e1e1e;
      color: #d4d4d4;
      border-radius: 8px;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      max-height: 300px;
      overflow-y: auto;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .log-entry {
      margin: 3px 0;
      padding: 2px 0;
    }
    
    .log-reject {
      color: #f48771;
    }
    
    .log-accept {
      color: #89d185;
    }
    
    .log-info {
      color: #4fc1ff;
    }
    
    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin: 20px 0;
    }
    
    .stat-card {
      background: white;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .stat-label {
      font-size: 12px;
      color: #666;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .stat-value {
      font-size: 28px;
      font-weight: bold;
      color: #007bff;
      margin-top: 5px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üñêÔ∏è Palm Rejection Manual Test</h1>
    <p class="subtitle">Test the 3-tier palm rejection system with your actual hardware</p>
    
    <div class="stats">
      <div class="stat-card">
        <div class="stat-label">Total Touches</div>
        <div class="stat-value" id="stat-total">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Accepted</div>
        <div class="stat-value" id="stat-accepted" style="color: #28a745;">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Rejected</div>
        <div class="stat-value" id="stat-rejected" style="color: #dc3545;">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Rejection Rate</div>
        <div class="stat-value" id="stat-rate">0%</div>
      </div>
    </div>
    
    <canvas id="testCanvas" class="test-canvas"></canvas>
    
    <div class="controls">
      <h3>Palm Rejection Settings</h3>
      
      <div class="control-group">
        <label for="sizeThreshold">Size Threshold:</label>
        <input type="range" id="sizeThreshold" min="10" max="60" value="30" step="1">
        <span class="value-display" id="sizeThresholdValue">30px</span>
      </div>
      
      <div class="control-group">
        <label for="temporalDelay">Temporal Delay:</label>
        <input type="range" id="temporalDelay" min="0" max="100" value="40" step="5">
        <span class="value-display" id="temporalDelayValue">40ms</span>
      </div>
      
      <div class="control-group">
        <label for="velocityThreshold">Velocity Threshold:</label>
        <input type="range" id="velocityThreshold" min="1" max="10" value="2" step="0.5">
        <span class="value-display" id="velocityThresholdValue">2px</span>
      </div>
      
      <div class="control-group">
        <label for="enableTemporal">Enable Temporal Delay:</label>
        <input type="checkbox" id="enableTemporal" checked>
      </div>
      
      <div class="control-group">
        <label for="enableVelocity">Enable Velocity Analysis:</label>
        <input type="checkbox" id="enableVelocity" checked>
      </div>
      
      <div class="control-group">
        <label for="enableEdge">Enable Edge Filtering:</label>
        <input type="checkbox" id="enableEdge">
      </div>
      
      <div style="margin-top: 20px;">
        <button class="btn-primary" onclick="resetStats()">Reset Stats</button>
        <button class="btn-secondary" onclick="clearCanvas()">Clear Canvas</button>
        <button class="btn-danger" onclick="clearLog()">Clear Log</button>
      </div>
    </div>
    
    <div class="log" id="log">
      <div class="log-entry log-info">üöÄ Palm Rejection Test Ready</div>
      <div class="log-entry log-info">üìù Draw with stylus and rest your palm to test</div>
    </div>
  </div>

  <script>
    // Test harness
    const canvas = document.getElementById('testCanvas');
    const ctx = canvas.getContext('2d');
    const log = document.getElementById('log');
    
    // Stats
    let stats = {
      total: 0,
      accepted: 0,
      rejected: 0
    };
    
    // Active pointers
    const activePointers = new Map();
    const pendingPointers = new Map();
    
    // Resize canvas
    function resizeCanvas() {
      const rect = canvas.getBoundingClientRect();
      canvas.width = rect.width * window.devicePixelRatio;
      canvas.height = rect.height * window.devicePixelRatio;
      ctx.scale(window.devicePixelRatio, window.devicePixelRatio);
    }
    
    resizeCanvas();
    window.addEventListener('resize', resizeCanvas);
    
    // Logging
    function addLog(message, type = 'info') {
      const entry = document.createElement('div');
      entry.className = `log-entry log-${type}`;
      entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
      log.appendChild(entry);
      log.scrollTop = log.scrollHeight;
    }
    
    function updateStats() {
      document.getElementById('stat-total').textContent = stats.total;
      document.getElementById('stat-accepted').textContent = stats.accepted;
      document.getElementById('stat-rejected').textContent = stats.rejected;
      const rate = stats.total > 0 ? ((stats.rejected / stats.total) * 100).toFixed(1) : 0;
      document.getElementById('stat-rate').textContent = rate + '%';
    }
    
    function resetStats() {
      stats = { total: 0, accepted: 0, rejected: 0 };
      updateStats();
      addLog('üìä Stats reset', 'info');
    }
    
    function clearCanvas() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      addLog('üóëÔ∏è Canvas cleared', 'info');
    }
    
    function clearLog() {
      log.innerHTML = '';
      addLog('üöÄ Log cleared', 'info');
    }
    
    // Get settings
    function getSettings() {
      return {
        sizeThreshold: parseInt(document.getElementById('sizeThreshold').value),
        temporalDelayMs: parseInt(document.getElementById('temporalDelay').value),
        velocityThreshold: parseFloat(document.getElementById('velocityThreshold').value),
        enableTemporalDelay: document.getElementById('enableTemporal').checked,
        enableVelocityAnalysis: document.getElementById('enableVelocity').checked,
        enableEdgeFiltering: document.getElementById('enableEdge').checked
      };
    }
    
    // Update value displays
    document.getElementById('sizeThreshold').addEventListener('input', (e) => {
      document.getElementById('sizeThresholdValue').textContent = e.target.value + 'px';
    });
    document.getElementById('temporalDelay').addEventListener('input', (e) => {
      document.getElementById('temporalDelayValue').textContent = e.target.value + 'ms';
    });
    document.getElementById('velocityThreshold').addEventListener('input', (e) => {
      document.getElementById('velocityThresholdValue').textContent = e.target.value + 'px';
    });
    
    // Palm rejection logic
    function checkImmediateRejection(e) {
      const settings = getSettings();
      const size = Math.max(e.width || 0, e.height || 0);
      
      // Size check
      if (size > settings.sizeThreshold) {
        return { reject: true, reason: `Size ${size.toFixed(1)}px > threshold ${settings.sizeThreshold}px` };
      }
      
      // Edge check
      if (settings.enableEdgeFiltering) {
        const rect = canvas.getBoundingClientRect();
        const relativeY = (e.clientY - rect.top) / rect.height;
        if (relativeY > 0.85) {
          return { reject: true, reason: `Edge zone (${(relativeY * 100).toFixed(1)}%)` };
        }
      }
      
      return { reject: false };
    }
    
    function acceptPointer(e) {
      stats.total++;
      stats.accepted++;
      updateStats();
      
      const size = Math.max(e.width || 0, e.height || 0);
      addLog(`‚úÖ Accepted pointer ${e.pointerId} (${size.toFixed(1)}px)`, 'accept');
      
      // Start drawing
      activePointers.set(e.pointerId, {
        x: e.clientX,
        y: e.clientY,
        startTime: performance.now(),
        totalMovement: 0,
        size: size
      });
      
      ctx.beginPath();
      ctx.moveTo(e.clientX, e.clientY);
    }
    
    function rejectPointer(id, reason) {
      stats.total++;
      stats.rejected++;
      updateStats();
      
      addLog(`‚ùå Rejected pointer ${id}: ${reason}`, 'reject');
    }
    
    // Pointer event handlers
    canvas.addEventListener('pointerdown', (e) => {
      if (e.pointerType !== 'touch') return;
      
      const size = Math.max(e.width || 0, e.height || 0);
      addLog(`üëÜ Pointer down: ${e.pointerId} (${size.toFixed(1)}px)`, 'info');
      
      // Tier 1: Immediate rejection
      const immediateCheck = checkImmediateRejection(e);
      if (immediateCheck.reject) {
        rejectPointer(e.pointerId, immediateCheck.reason);
        return;
      }
      
      const settings = getSettings();
      
      // Tier 2: Temporal delay
      if (settings.enableTemporalDelay && size >= settings.sizeThreshold * 0.5) {
        addLog(`‚è±Ô∏è Queuing pointer ${e.pointerId} for ${settings.temporalDelayMs}ms`, 'info');
        
        const timeoutId = setTimeout(() => {
          pendingPointers.delete(e.pointerId);
          acceptPointer(e);
        }, settings.temporalDelayMs);
        
        pendingPointers.set(e.pointerId, { event: e, timeoutId, size });
        
        // Check if smaller touch already exists
        for (const [id, data] of activePointers) {
          if (data.size < size * 0.7) {
            clearTimeout(timeoutId);
            pendingPointers.delete(e.pointerId);
            rejectPointer(e.pointerId, `Smaller stylus active (${data.size.toFixed(1)}px)`);
            return;
          }
        }
      } else {
        // Accept immediately (small touch = stylus)
        acceptPointer(e);
        
        // Reject any pending larger touches
        for (const [id, data] of pendingPointers) {
          if (data.size > size * 1.5) {
            clearTimeout(data.timeoutId);
            pendingPointers.delete(id);
            rejectPointer(id, `Rejected by smaller stylus (${size.toFixed(1)}px)`);
          }
        }
      }
    });
    
    canvas.addEventListener('pointermove', (e) => {
      const active = activePointers.get(e.pointerId);
      if (!active) return;
      
      // Update movement
      const dx = e.clientX - active.x;
      const dy = e.clientY - active.y;
      const movement = Math.sqrt(dx * dx + dy * dy);
      active.totalMovement += movement;
      active.x = e.clientX;
      active.y = e.clientY;
      
      // Draw
      ctx.lineTo(e.clientX, e.clientY);
      ctx.strokeStyle = '#007bff';
      ctx.lineWidth = 2;
      ctx.lineCap = 'round';
      ctx.stroke();
      
      // Tier 3: Velocity analysis
      const settings = getSettings();
      if (settings.enableVelocityAnalysis) {
        const elapsed = performance.now() - active.startTime;
        if (elapsed > 100 && active.size > settings.sizeThreshold * 0.8 && active.totalMovement < settings.velocityThreshold) {
          addLog(`üõë Velocity rejection: ${active.totalMovement.toFixed(1)}px in ${elapsed.toFixed(0)}ms`, 'reject');
          activePointers.delete(e.pointerId);
          stats.rejected++;
          updateStats();
        }
      }
    });
    
    canvas.addEventListener('pointerup', (e) => {
      // Clear pending
      const pending = pendingPointers.get(e.pointerId);
      if (pending) {
        clearTimeout(pending.timeoutId);
        pendingPointers.delete(e.pointerId);
      }
      
      // Clear active
      activePointers.delete(e.pointerId);
    });
    
    addLog('‚úÖ Test harness initialized', 'info');
  </script>
</body>
</html>
